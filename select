SELECT
    accounts.id,
    accounts.username,
    accounts.email,
    COALESCE((
        SELECT balance FROM balances WHERE wallet = wallets.id
    ), 0) as balance_msat,
    (
        SELECT COUNT(*) FROM apipayments WHERE wallet = wallets.id
    ) as transaction_count,
    (
        SELECT time FROM apipayments WHERE wallet = wallets.id order by time desc limit 1
    ) as last_payment
FROM accounts RIGHT JOIN wallets ON accounts.id = wallets.user
WHERE (SELECT COUNT(*) FROM apipayments WHERE wallet = wallets.id) > 0
GROUP BY wallets.user, accounts.id, wallets.id
ORDER by last_payment ASC
LIMIT 13;
