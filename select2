SELECT
    accounts.id,
    accounts.username,
    accounts.email,
    (
        SELECT COUNT(*) FROM apipayments WHERE wallet = wallets.id
    ) as transaction_count,
    (
     SELECT COUNT(*) FROM wallets WHERE wallets.user = accounts.id
    ) as wallet_count,
    (
     SELECT COUNT(*) FROM apipayments WHERE wallet = wallets.id
    ) as transaction_count,
    (
     SELECT SUM(amount) FROM apipayments
     WHERE amount > 0 AND wallet = wallets.id
    ) as transaction_in,
    (
     SELECT SUM(amount) FROM apipayments
     WHERE amount < 0 AND wallet = wallets.id
    ) as transaction_out,
    (
     SELECT SUM(balance) FROM balances WHERE wallet = wallets.id
    ) as balance_msat
FROM accounts LEFT JOIN wallets on accounts.id = wallets.user
WHERE transaction_count > 0
ORDER BY transaction_count DESC
